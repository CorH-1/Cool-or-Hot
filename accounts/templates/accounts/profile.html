<!-- accounts/templates/accounts/prorile.html -->

{% extends 'base.html' %}

{% block link %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
{% endblock link %}

{% block style %}
<style>
  body {
    font-family: 'Nanum Gothic', sans-serif;
  }
</style>
{% endblock style %}

{% block content %}
<div class="container d-flex justify-content-between">
  <!-- 왼쪽영역 -->
    <div class="left_field col-4">
      <!-- 유저정보 영역 -->
      <div class="user_box text-center">
        <!-- 이미지 -->
        <div class="profile_img mt-4 mb-4">
          {% if person.profile_image %}
              <img class="rounded-circle" src="{{ person.profile_image.url }}" alt="Profile Image">
          {% else %}
              <img class="rounded-circle" src="https://i.postimg.cc/kXwSg0M2/image.jpg" alt="Default Profile Image">
          {% endif %}
        </div>
        <!-- 프로필 -->
        <div class="user_info">
          <h2 class="user-name fw-bold">{{ person.username }}</h2>
          <div class="social_icon">
            {% if user.email %}
            <a class='text-dark' href="javascript:void(0)" onclick="copyToClipboard('{{ user.email }}')">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">
                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
              </svg>
            </a>
            <script>
              function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                const notification = document.createElement('div');
                notification.innerText = '이메일 주소가 복사되었습니다.';
                notification.style.position = 'fixed';
                notification.style.bottom = '10px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.background = '#f2f2f2';
                notification.style.padding = '10px';
                notification.style.borderRadius = '5px';
                notification.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                
                document.body.appendChild(notification);
                setTimeout(function() {
                  document.body.removeChild(notification);
                }, 3000);
              }
            </script>
          {% endif %}
          </div>
        </div>
        <!-- 로그인+본인 프로필이어야 노출되는 부분 -->
        <div class="Enable Login my-3">
          {% if user == person %}
          <div class="profile_update">
            <a href="{% url 'accounts:update' %}">
              <button class="btn btn-outline-dark" style="width: 144px;">프로필 업데이트</button>
            </a>
          </div>
          <div class="change_password">
            <a href="{% url 'accounts:password' %}">
              <button class="btn btn-outline-dark mt-2" style="width: 144px;">비밀번호 변경</button>
            </a>
          </div>
          <div class='small'>
            <br>
            <br>
            <br>
            <br>
            <a class='text-body-tertiary link-underline link-underline-opacity-0' href={% url 'accounts:delete' username=user.username %}>
              <p>              
                회원탈퇴
              </p>
            </a>
          {% else %}
            <div class="follow-btn">
              <form class="follow-form" data-user-id="{{ person.pk }}">
                {% csrf_token %}
                {% if request.user in person.followers.all %}
                  <input type="submit" value="언팔로우" class="btn btn-dark fw-bold">
                {% else %}
                  <input type="submit" value="팔로우" class="btn btn-outline-dark fw-bold {% if not user.is_authenticated %}disabled{% endif %}">
                {% endif %}
              </form>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // JavaScript 코드
document.addEventListener('DOMContentLoaded', function() {
  const followForms = document.getElementsByClassName('follow-form');

  // 각 팔로우 폼에 대한 이벤트 리스너 등록
  Array.from(followForms).forEach(function(form) {
    form.addEventListener('submit', function(event) {
      event.preventDefault(); // 폼 제출 기본 동작 방지

      const csrfToken = form.getElementsByTagName('input')[0].value; // CSRF 토큰 값 가져오기
      const isFollowed = form.getElementsByClassName('btn')[0].value === '언팔로우'; // 현재 팔로우 상태
      const userPk = form.getAttribute('data-user-id'); // 사용자 고유 식별자

      // Ajax 요청 설정
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/accounts/' + userPk + '/follow/');
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader('X-CSRFToken', csrfToken);

      // 요청 완료 후 처리
      xhr.onload = function() {
        if (xhr.status === 200) {
          const response = JSON.parse(xhr.responseText);

          // 팔로우 상태에 따른 버튼 및 팔로워 수 업데이트
          const followButton = form.getElementsByClassName('btn')[0];
          const followerCount = document.getElementById('follower-count-' + userPk);

          if (isFollowed) {
            followButton.value = '팔로우';
            followButton.classList.remove('btn-dark');
            followButton.classList.add('btn-outline-dark');
            followerCount.textContent = response.follower_count;
          } else {
            followButton.value = '언팔로우';
            followButton.classList.remove('btn-outline-dark');
            followButton.classList.add('btn-dark');
            followerCount.textContent = response.follower_count;
          }
        } else {
          console.error('팔로우 요청 실패');
        }
      };

      // 요청 전송
      xhr.send();
    });
  });
});

</script>
{% endblock content %}
{% comment %} 
<!-- 
  <div class="right_field col-8 mt-4">
    <P CLASS='fw-bold'>좋아요 한 취미</P>
    <div class="group_like rounded border border-dark">
      <div class="card" style="width: 18rem;">
        <a href="#">
          <img src="{{ PostImage.url }}" class="card-img-top">
        </a>
        <div class="card-body">
          <h5 class="card-title">{{ Post.title }}</h5>
          <p class="card-text">{{ Post.content }}</p>          
        </div>
      </div>
    </div>
  </div>
      

      오른쪽 영역
      <div class="right_field col-8 mt-4">
        <div class="bookmark">
          <p class="fw-bold">북마크한 취미</p>
          <div class="bookmark_list">
            <p>아직 북마크한 내용이 없어요.</p>
            <a href="">
              <button>취미 찾으러 가기</button>
            </a>
          </div>
        </div>
        <div class="join_group my-4">
          <p class="fw-bold">참여하는 모임</p>
          <div class="bookmark_list">
            <p>아직 가입한 모임이 없어요.</p>
            <a href="">
              <button>내 주변 모임 찾아보기</button>
            </a>          
          </div>
        </div>
      </div>
      --> {% endcomment %}